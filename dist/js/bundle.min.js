function registerServiceWorker(){"serviceWorker"in navigator?window.addEventListener("load",()=>{navigator.serviceWorker.register("/sw.js",{scope:"/"}).then(e=>{if(console.log("Service worker registration succeeded. Scope is "+e.scope),navigator.serviceWorker.controller)return e.waiting?(updateReady(e.waiting),void console.log("Service worker is waiting")):e.installing?(trackInstalling(e.installing),void console.log("Service worker is installing")):void e.addEventListener("updatefound",function(){trackInstalling(e.installing),console.log("New update is found")});console.log("This page is not currently controlled by a service worker.")}).catch(e=>{console.log("Registration failed with "+e)}),navigator.serviceWorker.addEventListener("controllerchange",()=>{console.log("Reload..."),window.location.reload()})}):console.log("Service worker is not supported by your browser")}function updateReady(e){window.alert("New update found"),e.postMessage({action:"skipWaiting"})}function trackInstalling(e){e.addEventListener("statechange",()=>{"installed"==e.state&&updateReady(e)})}registerServiceWorker();let staticCacheName="mws-static-v1",contentImgsCache="mws-content-imgs",allCaches=[staticCacheName,contentImgsCache],staticFilesName=["/dist/img/favicon.png","/dist/img/favicon-196.png","/dist/img/favicon-512.png","/index.html","/restaurant.html","/dist/css/styles.css","/js/lib/idb.js","/js/idbhelper.js","/js/main.js","/js/restaurant_info.js","/dist/js/bundle.min.js","https://unpkg.com/leaflet@1.3.1/dist/leaflet.js","https://unpkg.com/leaflet@1.3.1/dist/leaflet.css","https://unpkg.com/leaflet@1.3.1/dist/images/marker-icon.png","https://unpkg.com/leaflet@1.3.1/dist/images/marker-icon-2x.png","https://unpkg.com/leaflet@1.3.1/dist/images/marker-shadow.png","https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"];self.addEventListener("install",e=>{console.log("Install service worker and cache static assets"),e.waitUntil(caches.open(staticCacheName).then(e=>(console.log("Caching sucess"),e.addAll(staticFilesName))))}),self.addEventListener("activate",e=>{console.log("Activating new service worker..."),e.waitUntil(caches.keys().then(e=>Promise.all(e.filter(e=>e.startsWith("mws-")&&!allCaches.includes(e)).map(e=>caches.delete(e)))))}),self.addEventListener("fetch",e=>{e.respondWith(caches.open(allCaches).then(t=>t.match(e.request).then(n=>n||fetch(e.request).then(n=>(t.put(e.request,n.clone()),n)))))}),self.addEventListener("message",e=>{console.log("Perform skip waiting"),"skipWaiting"===e.data.action&&(console.log("skip waiting...."),self.skipWaiting())}),function(){function e(e){return new Promise(function(t,n){e.onsuccess=function(){t(e.result)},e.onerror=function(){n(e.error)}})}function t(t,n,r){var a,o=new Promise(function(o,s){e(a=t[n].apply(t,r)).then(o,s)});return o.request=a,o}function n(e,t,n){n.forEach(function(n){Object.defineProperty(e.prototype,n,{get:function(){return this[t][n]}})})}function r(e,n,r,a){a.forEach(function(a){a in r.prototype&&(e.prototype[a]=function(){return t(this[n],a,arguments)})})}function a(e,t,n,r){r.forEach(function(r){r in n.prototype&&(e.prototype[r]=function(){return this[t][r].apply(this[t],arguments)})})}function o(e,n,r,a){a.forEach(function(a){a in r.prototype&&(e.prototype[a]=function(){return e=this[n],(r=t(e,a,arguments)).then(function(e){if(e)return new i(e,r.request)});var e,r})})}function s(e){this._index=e}function i(e,t){this._cursor=e,this._request=t}function c(e){this._store=e}function l(e){this._tx=e,this.complete=new Promise(function(t,n){e.oncomplete=function(){t()},e.onerror=function(){n(e.error)}})}function d(e,t,n){this._db=e,this.oldVersion=t,this.transaction=new l(n)}function u(e){this._db=e}n(s,"_index",["name","keyPath","multiEntry","unique"]),r(s,"_index",IDBIndex,["get","getKey","getAll","getAllKeys","count"]),o(s,"_index",IDBIndex,["openCursor","openKeyCursor"]),n(i,"_cursor",["direction","key","primaryKey","value"]),r(i,"_cursor",IDBCursor,["update","delete"]),["advance","continue","continuePrimaryKey"].forEach(function(t){t in IDBCursor.prototype&&(i.prototype[t]=function(){var n=this,r=arguments;return Promise.resolve().then(function(){return n._cursor[t].apply(n._cursor,r),e(n._request).then(function(e){if(e)return new i(e,n._request)})})})}),c.prototype.createIndex=function(){return new s(this._store.createIndex.apply(this._store,arguments))},c.prototype.index=function(){return new s(this._store.index.apply(this._store,arguments))},n(c,"_store",["name","keyPath","indexNames","autoIncrement"]),r(c,"_store",IDBObjectStore,["put","add","delete","clear","get","getAll","getAllKeys","count"]),o(c,"_store",IDBObjectStore,["openCursor","openKeyCursor"]),a(c,"_store",IDBObjectStore,["deleteIndex"]),l.prototype.objectStore=function(){return new c(this._tx.objectStore.apply(this._tx,arguments))},n(l,"_tx",["objectStoreNames","mode"]),a(l,"_tx",IDBTransaction,["abort"]),d.prototype.createObjectStore=function(){return new c(this._db.createObjectStore.apply(this._db,arguments))},n(d,"_db",["name","version","objectStoreNames"]),a(d,"_db",IDBDatabase,["deleteObjectStore","close"]),u.prototype.transaction=function(){return new l(this._db.transaction.apply(this._db,arguments))},n(u,"_db",["name","version","objectStoreNames"]),a(u,"_db",IDBDatabase,["close"]),["openCursor","openKeyCursor"].forEach(function(e){[c,s].forEach(function(t){t.prototype[e.replace("open","iterate")]=function(){var t,n=(t=arguments,Array.prototype.slice.call(t)),r=n[n.length-1],a=(this._store||this._index)[e].apply(this._store,n.slice(0,-1));a.onsuccess=function(){r(a.result)}}})}),[s,c].forEach(function(e){e.prototype.getAll||(e.prototype.getAll=function(e,t){var n=this,r=[];return new Promise(function(a){n.iterateCursor(e,function(e){e?(r.push(e.value),void 0===t||r.length!=t?e.continue():a(r)):a(r)})})})});var p={open:function(e,n,r){var a=t(indexedDB,"open",[e,n]),o=a.request;return o.onupgradeneeded=function(e){r&&r(new d(o.result,e.oldVersion,o.transaction))},a.then(function(e){return new u(e)})},delete:function(e){return t(indexedDB,"deleteDatabase",[e])}};"undefined"!=typeof module?module.exports=p:self.idb=p}();const IDB_NAME="mwsrestaurants",IDB_VERSION=1,MAPBOX_TOKEN="pk.eyJ1IjoicmVzYW50IiwiYSI6ImNqaW5oNXpwMjA5ZnQzd3BiMmtrNWFueHYifQ.SA7IDB7hI_d6bT5RtGeQfg",SERVER_URL="http://localhost:1337/restaurants";class Restaurant{constructor(e){this.id=e.id,this.name=e.name,this.neighborhood=e.neighborhood,this.photograph=e.photograph,this.address=e.address,this.latlng=e.latlng,this.cuisine_type=e.cuisine_type,this.operating_hours=e.operating_hours,this.reviews=e.reviews,this.createdAt=e.createdAt,this.updatedAt=e.updatedAt}}class IDBHelper{static get DATABASE_URL(){window.location.href;return window.location.origin||(window.location.origin=window.location.protocol+"//"+window.location.hostname+(window.location.port?":"+window.location.port:"")),SERVER_URL}static get idb(){return!navigator.serviceWorker||!1 in window?(console.log("This browser doesn't support IndexedDB"),Promise.reject()):idb.open(IDB_NAME,IDB_VERSION,e=>{e.objectStoreNames.contains("restaurants")||e.createObjectStore("restaurants",{keyPath:"id"}).createIndex("by-id","id")})}static getData(e,t,n){return IDBHelper.idb.then(r=>{const a=r.transaction(e).objectStore(e);return n?a.index(t).getAll(n):(console.log("check="+n),a.getAll())})}static addData(e,t){return IDBHelper.idb.then(n=>{const r=n.transaction(e,"readwrite");return r.objectStore(e).put(t),r.complete})}static addToDatabase(e){return new Promise((t,n)=>{IDBHelper.getData("restaurants","by-id",e.id).then(n=>{if(1===n.length)return t(e);IDBHelper.addData("restaurants",e).then(()=>{t(e)})}).catch(e=>{n(`Addding data to database failed. Returned status of ${e}`)})})}static fetchRestaurants(){let e;return fetch(IDBHelper.DATABASE_URL).then(e=>e.json()).then(e=>e.map(e=>new Restaurant(e))).then(t=>{e=t;let n=Promise.resolve();return t.forEach(e=>n=n.then(()=>IDBHelper.addToDatabase(e))),n}).then(()=>e).catch(e=>{const t=`Fetching restaurant data failed. Returned status of ${e}`;return Promise.reject(t)})}static fetchRestaurantById(e){return console.log("fetching restaurant based on id"),IDBHelper.fetchRestaurants().then(t=>{const n=t.find(t=>t.id==e);return n?Promise.resolve(n):Promise.reject(error)})}static fetchRestaurantByCuisine(e,t){console.log("fetch restauranrt by cuisine"),IDBHelper.fetchRestaurants((n,r)=>{if(n)t(n,null);else{const n=r.filter(t=>t.cuisine_type==e);t(null,n)}})}static fetchRestaurantByNeighborhood(e,t){console.log("fetch restauranrt by neighborhood"),IDBHelper.fetchRestaurants((n,r)=>{if(n)t(n,null);else{const n=r.filter(t=>t.neighborhood==e);t(null,n)}})}static fetchRestaurantByCuisineAndNeighborhood(e,t){return IDBHelper.fetchRestaurants(n=>{let r=n;return"all"!=e&&(r=r.filter(t=>t.cuisine_type==e)),"all"!=t&&(r=r.filter(e=>e.neighborhood==t)),Promise.resolve(r)}).catch(e=>{const t=`Fetch restaurants data by cuisine and neighborhood failed. Returned status of ${e}`;return Promise.reject(t)})}static fetchNeighborhoods(e){return new Promise((t,n)=>{const r=e.map((t,n)=>e[n].neighborhood);return t(r.filter((e,t)=>r.indexOf(e)==t))}).catch(e=>{return reject(`Fetching neighborhoods data failed. Returned status of ${e}`)})}static fetchCuisines(e){return new Promise((t,n)=>{const r=e.map((t,n)=>e[n].cuisine_type);return t(r.filter((e,t)=>r.indexOf(e)==t))}).catch(e=>{return reject(`Fetching cuisine data failed. Returned status of ${e}`)})}static urlForRestaurant(e){return`./restaurant.html?id=${e.id}`}static imageUrlForRestaurant(e){return`/dist/img/${e.photograph}`}static mapMarkerForRestaurant(e,t){const n=new L.marker([e.latlng.lat,e.latlng.lng],{title:e.name,alt:e.name,url:IDBHelper.urlForRestaurant(e)});return n.addTo(newMap),n}}let restaurants,neighborhoods,cuisines;var markers=[];let restaurant;var newMap;document.addEventListener("DOMContentLoaded",e=>{initMap(),updateRestaurants().then(e=>{fetchNeighborhoods(self.restaurants),fetchCuisines(self.restaurants)})}),fetchNeighborhoods=(e=>{IDBHelper.fetchNeighborhoods(e).then(e=>{self.neighborhoods=e,fillNeighborhoodsHTML()}).catch(e=>{const t=`Fill neighborhoods data filter failed. Returned status of ${e}`;console.log(t)})}),fillNeighborhoodsHTML=((e=self.neighborhoods)=>{const t=document.getElementById("neighborhoods-select");e.forEach(e=>{const n=document.createElement("option");n.innerHTML=e,n.value=e,t.append(n)})}),fetchCuisines=(e=>{IDBHelper.fetchCuisines(e).then(e=>{self.cuisines=e,fillCuisinesHTML()}).catch(e=>{const t=`Fill cuisine data filter failed. Returned status of ${e}`;console.log(t)})}),fillCuisinesHTML=((e=self.cuisines)=>{const t=document.getElementById("cuisines-select");e.forEach(e=>{const n=document.createElement("option");n.innerHTML=e,n.value=e,t.append(n)})}),initMap=(()=>{self.newMap=L.map("map",{center:[40.722216,-73.987501],zoom:12,scrollWheelZoom:!1}),L.tileLayer("https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.jpg70?access_token={mapboxToken}",{mapboxToken:MAPBOX_TOKEN,maxZoom:18,attribution:'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',id:"mapbox.streets"}).addTo(newMap)}),updateRestaurants=(()=>new Promise((e,t)=>{const n=document.getElementById("cuisines-select"),r=document.getElementById("neighborhoods-select"),a=n.selectedIndex,o=r.selectedIndex,s=n[a].value,i=r[o].value;return IDBHelper.fetchRestaurantByCuisineAndNeighborhood(s,i).then(t=>{resetRestaurants(t),fillRestaurantsHTML(),e(t)}).catch(e=>{console.log(e),t(e)})})),resetRestaurants=(e=>{self.restaurants=[],document.getElementById("restaurants-list").innerHTML="",self.markers&&self.markers.forEach(e=>e.remove()),self.markers=[],self.restaurants=e}),fillRestaurantsHTML=((e=self.restaurants)=>{const t=document.getElementById("restaurants-list");document.getElementById("total-restaurant-list").innerHTML=`${e.length} restaurant${0===e.length?"":"s"} found`,e.forEach(e=>{t.append(createRestaurantHTML(e))}),addMarkersToMap()}),createRestaurantHTML=(e=>{const t=document.createElement("li"),n=document.createElement("picture"),r=document.createElement("img"),a=document.createElement("source"),o=document.createElement("source"),s=IDBHelper.imageUrlForRestaurant(e).replace(/\.[^\/.]+$/,"");r.className="restaurant-img",r.src=`${s}_medium.jpg`,r.alt=e.name,a.media="(max-width: 789px)",a.srcset=`${s}_small.webp`,o.media="(min-width: 790px)",o.srcset=`${s}_medium.webp`,t.append(n),n.append(a),n.append(o),n.append(r);const i=document.createElement("h3");i.innerHTML=e.name,t.append(i);const c=document.createElement("p");c.innerHTML=e.neighborhood,t.append(c);const l=document.createElement("p");l.innerHTML=e.address,t.append(l);const d=document.createElement("a");return d.setAttribute("aria-label",`View restaurant details of ${e.name}`),d.innerHTML="View Details",d.href=IDBHelper.urlForRestaurant(e),d.alt="View Details",t.append(d),t}),addMarkersToMap=((e=self.restaurants)=>{e.forEach(e=>{const t=IDBHelper.mapMarkerForRestaurant(e,self.newMap);t.on("click",function(){window.location.href=t.options.url}),self.markers.push(t)})}),resetFilter=(()=>{const e=document.getElementById("neighborhoods-select"),t=document.getElementById("cuisines-select");e.options.selectedIndex=0,t.options.selectedIndex=0,updateRestaurants()}),document.addEventListener("DOMContentLoaded",e=>{console.log("Page is loaded"),initMap()}),initMap=(()=>{fetchRestaurantFromURL().then(e=>{self.newMap=L.map("map",{center:[e.latlng.lat,e.latlng.lng],zoom:16,scrollWheelZoom:!1}),L.tileLayer("https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.jpg70?access_token={mapboxToken}",{mapboxToken:MAPBOX_TOKEN,maxZoom:18,attribution:'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',id:"mapbox.streets"}).addTo(newMap),fillBreadcrumb(),IDBHelper.mapMarkerForRestaurant(self.restaurant,self.map)}).catch(e=>{console.log(e)})}),fetchRestaurantFromURL=(()=>new Promise((e,t)=>{self.restaurant&&e(self.restaurant);const n=getParameterByName("id");n?IDBHelper.fetchRestaurantById(n).then(n=>{self.restaurant=n,n||(console.error(error),t(error)),fillRestaurantHTML(),e(n)}):(error="No restaurant id in URL",t(error))})),randomIpsumeGenerator=(()=>{const e=["Bacon ipsum dolor amet jowl chuck pork loin. ","Ball tip burgdoggen alcatra cow tri-tip beef, swine buffalo brisket spare ribs pork. ","Landjaeger turkey filet mignon cow kielbasa sausage picanha sirloin. ","Kevin sirloin ham pancetta tenderloin, drumstick sausage short ribs cow leberkas chuck cupim shankle. "],t=e[Math.floor(Math.random()*e.length)];let n=Math.floor(2*Math.random()+2),r="";for(var a=0;a<n;a++)r+=t+" ";return r}),fillRestaurantHTML=((e=self.restaurant)=>{document.getElementById("restaurant-name").innerHTML=e.name,document.getElementById("restaurant-address").innerHTML=e.address;const t=randomIpsumeGenerator();document.getElementById("restaurant-description").innerHTML=t;const n=document.getElementById("restaurant-img"),r=document.getElementById("restaurant-img-responsive"),a=IDBHelper.imageUrlForRestaurant(e).replace(/\.[^\/.]+$/,""),o=document.createElement("source"),s=document.createElement("source");n.className="restaurant-img",n.src=`${a}_medium.jpg`,n.alt=e.name,o.media="(max-width: 789px)",o.srcset=`${a}_medium.webp`,s.media="(min-width: 790px)",s.srcset=`${a}_large.webp`,r.prepend(s),r.prepend(o),document.getElementById("restaurant-cuisine").innerHTML=e.cuisine_type,e.operating_hours&&fillRestaurantHoursHTML(),fillReviewsHTML()}),fillRestaurantHoursHTML=((e=self.restaurant.operating_hours)=>{const t=document.getElementById("restaurant-hours");for(let n in e){const r=document.createElement("tr"),a=document.createElement("td");a.innerHTML=n,r.appendChild(a);const o=document.createElement("td");o.innerHTML=e[n],r.appendChild(o),t.appendChild(r)}}),fillReviewsHTML=((e=self.restaurant.reviews)=>{const t=document.getElementById("reviews-container"),n=document.createElement("h3");if(n.innerHTML="Reviews",t.appendChild(n),!e){const e=document.createElement("p");return e.innerHTML="No reviews yet!",void t.appendChild(e)}const r=document.getElementById("reviews-list");e.forEach(e=>{r.appendChild(createReviewHTML(e))}),t.appendChild(r)}),createReviewHTML=(e=>{const t=document.createElement("li"),n=document.createElement("p");n.classList.add("revname"),n.innerHTML=e.name,t.appendChild(n);const r=document.createElement("p");r.innerHTML=e.date,r.classList.add("revdate"),t.appendChild(r);const a=document.createElement("p");a.innerHTML=`Rating: ${createRatingStar(e.rating)}`,a.classList.add("revrating"),t.appendChild(a);const o=document.createElement("p");return o.innerHTML=e.comments,o.classList.add("revcomments"),t.appendChild(o),t}),createRatingStar=(e=>{let t="",n=1;for(;n<=5;)t+=n<=e&&n<=5?"<span class='fa fa-star checked'></span>":"<span class='fa fa-star'></span>",n++;return t}),fillBreadcrumb=((e=self.restaurant)=>{const t=document.getElementById("breadcrumb"),n=document.createElement("li");n.innerHTML=e.name,n.setAttribute("aria-current","page"),t.appendChild(n)}),getParameterByName=((e,t)=>{t||(t=window.location.href),e=e.replace(/[\[\]]/g,"\\$&");const n=new RegExp(`[?&]${e}(=([^&#]*)|&|#|$)`).exec(t);return n?n[2]?decodeURIComponent(n[2].replace(/\+/g," ")):"":null});